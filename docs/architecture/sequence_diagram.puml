@startuml Sequence Diagram - SharePoint Change Processing
!define AZURE_COLOR #0078D4
!define FUNCTION_COLOR #FF6600
!define SERVICE_COLOR #00AA44

title SharePoint Change Processing - Message Flow

actor "SharePoint" as SP
participant "SharePoint\nWebhook\nCallback" as Webhook FUNCTION_COLOR
participant "Default\nSharePointWebhook\nProcessor" as WebhookProcessor SERVICE_COLOR
participant "Azure\nService Bus" as SB AZURE_COLOR
participant "SharePointSync\nFunction" as SyncFunc FUNCTION_COLOR
participant "SharePoint\nSync\nProcessor" as SyncProcessor SERVICE_COLOR
participant "GraphApi\nClient" as Graph SERVICE_COLOR
participant "Excel\nParser" as Parser SERVICE_COLOR
participant "Database\nWriter" as DB SERVICE_COLOR
participant "Blob\nStorage" as Blob AZURE_COLOR

== Webhook Reception ==
SP -> Webhook: POST /sharepoint/notifications
activate Webhook

alt Handshake Request
    Webhook -> WebhookProcessor: TryHandshake(req)
    activate WebhookProcessor
    WebhookProcessor -> Webhook: HttpResponseData (validation token)
    deactivate WebhookProcessor
    Webhook -> SP: HTTP 200 + validation token
else Change Notification
    Webhook -> WebhookProcessor: BuildEnqueueAsync(req)
    activate WebhookProcessor
    WebhookProcessor -> WebhookProcessor: Build notification payload
    WebhookProcessor -> Webhook: (HttpResponseData, queueBody)
    deactivate WebhookProcessor
    Webhook -> SB: Enqueue message
    Webhook -> SP: HTTP 200 (accepted)
end
deactivate Webhook

== Message Processing ==
SB -> SyncFunc: ServiceBus Trigger (msg)
activate SyncFunc

SyncFunc -> SyncProcessor: EnsureGraphConnectionAsync()
activate SyncProcessor
SyncProcessor -> Graph: TestConnectionAsync()
activate Graph
Graph -> SyncProcessor: ConnectionResult
deactivate Graph

alt Connection Failed
    SyncProcessor -> SyncFunc: false
    deactivate SyncProcessor
    SyncFunc -> Blob: Save failed message
    SyncFunc -> SyncFunc: Log error & return
else Connection Success
    SyncProcessor -> SyncFunc: true
    deactivate SyncProcessor
    
    SyncFunc -> SyncFunc: Deserialize<NotificationEnvelope>(msg)
    
    loop For each ChangeNotification
        SyncFunc -> SyncProcessor: FetchAndStoreDeltaAsync()
        activate SyncProcessor
        
        SyncProcessor -> SyncProcessor: Begin Transaction & Extract itemId
        SyncProcessor -> Graph: GetListItemAsync() & GetDriveItemAsync()
        activate Graph
        Graph -> SyncProcessor: ListItem & DriveItem
        deactivate Graph
        
        opt ProcessFlag == "Yes"
            SyncProcessor -> Graph: DownloadAsync(driveId, itemId)
            activate Graph
            Graph -> SyncProcessor: Excel file stream
            deactivate Graph
            
            SyncProcessor -> Parser: Parse(stream)
            activate Parser
            Parser -> SyncProcessor: DataSet or error
            deactivate Parser
            
            opt Parse Success
                SyncProcessor -> DB: WriteAsync(dataSet)
                activate DB
                DB -> SyncProcessor: Success
                deactivate DB
                SyncProcessor -> SyncProcessor: Commit Transaction
            end
        end
        deactivate SyncProcessor
    end
end

deactivate SyncFunc

== Error Handling ==
alt Unhandled Exception
    SyncFunc -> Blob: Save failed message
    SyncFunc -> SyncFunc: Log error
    SyncFunc -> SB: Throw (trigger retry)
end

@enduml